{% extends "base.html" %}

{% block title %}AGBOT - Scan Plant{% endblock %}

{% block content %}
<div class="scan-page">
    <div class="scan-header">
        <button class="back-button" onclick="history.back()">
            <i class="fas fa-times"></i>
        </button>
        <h1>Scan Plant</h1>
    </div>

    <div class="scan-container">
        <div class="camera-view" id="cameraView">
            <div class="camera-placeholder" id="cameraPlaceholder">
                <i class="fas fa-camera"></i>
                <h2>Capture or Upload</h2>
                <p>Take a clear photo of the affected plant leaf or upload an existing image</p>
            </div>
            <img id="imagePreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
            <video id="videoElement" style="display: none; width: 100%; height: 100%;"></video>
        </div>

        <div class="scan-controls">
            <button class="primary-button" id="takePhotoBtn">
                <i class="fas fa-camera"></i> Take Photo
            </button>
            <label for="fileInput" class="secondary-button">
                <i class="fas fa-upload"></i> Upload Image
            </label>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <div class="photo-tips">
            <h3><i class="fas fa-camera"></i> Photo Tips</h3>
            <ul>
                <li>• Use natural lighting for best results</li>
                <li>• Capture the damaged area clearly</li>
                <li>• Include multiple damage points if possible</li>
                <li>• Avoid shadows and glare</li>
                <li>• Hold camera steady for sharp focus</li>
            </ul>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal" id="analysisModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-modal" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2>Scan Plant</h2>
            </div>
            <div class="modal-body">
                <div class="image-container">
                    <img id="analyzedImage" src="" alt="Plant image">
                </div>
                <button class="analyze-button" id="analyzeBtn">
                    <i class="fas fa-search"></i> Analyze Plant Health
                </button>
                <button class="secondary-button" id="retakeBtn">
                    Take Another Photo
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" style="display: none;">
        <div class="modal-content loading-content">
            <div class="loader"></div>
            <h3>Analyzing Image</h3>
            <p>Our AI is examining the damage pattern and identifying the pest species...</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const takePhotoBtn = document.getElementById('takePhotoBtn');
const fileInput = document.getElementById('fileInput');
const cameraView = document.getElementById('cameraView');
const cameraPlaceholder = document.getElementById('cameraPlaceholder');
const imagePreview = document.getElementById('imagePreview');
const videoElement = document.getElementById('videoElement');
const analysisModal = document.getElementById('analysisModal');
const loadingModal = document.getElementById('loadingModal');
const analyzedImage = document.getElementById('analyzedImage');
const analyzeBtn = document.getElementById('analyzeBtn');
const retakeBtn = document.getElementById('retakeBtn');
const closeModal = document.getElementById('closeModal');

let stream = null;
let capturedImage = null;

// Take Photo functionality
takePhotoBtn.addEventListener('click', async () => {
    if (stream) {
        // Capture photo from video stream
        capturePhoto();
    } else {
        // Start camera
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            videoElement.srcObject = stream;
            videoElement.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            imagePreview.style.display = 'none';
            videoElement.play();
            
            takePhotoBtn.innerHTML = '<i class="fas fa-camera"></i> Capture';
        } catch (err) {
            console.error('Camera access error:', err);
            alert('Unable to access camera. Please upload an image instead.');
        }
    }
});

// Capture photo from video stream
function capturePhoto() {
    const canvas = document.createElement('canvas');
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(videoElement, 0, 0);
    
    capturedImage = canvas.toDataURL('image/jpeg');
    
    // Stop camera
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    // Show captured image
    imagePreview.src = capturedImage;
    imagePreview.style.display = 'block';
    videoElement.style.display = 'none';
    takePhotoBtn.innerHTML = '<i class="fas fa-camera"></i> Take Photo';
    
    // Show analysis modal
    showAnalysisModal(capturedImage);
}

// File upload functionality
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            capturedImage = e.target.result;
            imagePreview.src = capturedImage;
            imagePreview.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            videoElement.style.display = 'none';
            
            // Show analysis modal
            showAnalysisModal(capturedImage);
        };
        reader.readAsDataURL(file);
    }
});

// Show analysis modal
function showAnalysisModal(imageSrc) {
    analyzedImage.src = imageSrc;
    analysisModal.style.display = 'flex';
}

// Analyze button
analyzeBtn.addEventListener('click', async () => {
    analysisModal.style.display = 'none';
    loadingModal.style.display = 'flex';
    
    // Animate progress bar
    const progressFill = document.querySelector('.progress-fill');
    progressFill.style.width = '0%';
    setTimeout(() => progressFill.style.width = '100%', 100);
    
    try {
        // Send image to backend for analysis
        const response = await fetch('/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_data: capturedImage
            })
        });
        
        const result = await response.json();
        
        // Redirect to results page
        setTimeout(() => {
            window.location.href = '/results';
        }, 2000);
        
    } catch (error) {
        console.error('Analysis error:', error);
        alert('Error analyzing image. Please try again.');
        loadingModal.style.display = 'none';
    }
});

// Retake photo
retakeBtn.addEventListener('click', () => {
    analysisModal.style.display = 'none';
    capturedImage = null;
    imagePreview.style.display = 'none';
    cameraPlaceholder.style.display = 'block';
});

// Close modal
closeModal.addEventListener('click', () => {
    analysisModal.style.display = 'none';
});

// Clean up camera on page unload
window.addEventListener('beforeunload', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}
